# API 请求问题排查与解决方案

## 问题分析

用户报告 API 请求失败，返回 `400 Bad Request - Bad Request` 错误。经过排查，发现问题的主要原因是：

1. **输入文本过长**：API 对输入文本长度有限制（约 500 字符）
2. **缺少明确的长度提示**：用户无法知道文本长度限制，导致输入超过限制

## 解决方案

我已经对代码进行了以下改进：

1. **添加文本长度限制**：
   - 实现了 500 字符的文本长度限制
   - 超过限制时自动截断并通知用户

2. **增强用户体验**：
   - 添加了实时文本长度指示器
   - 当文本接近限制（>450 字符）时显示红色警告
   - 明确标注最大字符限制

3. **改进错误处理**：
   - 添加了详细的调试日志
   - 提供更友好的错误提示

## 测试结果

使用用户提供的文本的前 500 字符进行测试，API 请求成功并生成了音频文件（`test_output.mp3`，大小 2.8MB）。

## 使用建议

1. **输入文本**：
   - 限制在 500 字符以内
   - 文本长度指示器会实时显示当前字符数
   - 超过限制时会自动截断并显示提示

2. **Prompt Audio URL**：
   - 确保 URL 可以公开访问
   - 建议使用 `.wav` 格式

3. **Prompt Text**：
   - 可选，用于提供提示音频对应的文本

## 技术说明

- API 密钥已迁移到 .env 文件并验证有效
- Prompt Audio URL (`https://raw.githubusercontent.com/hdapeng/kelong-audio/refs/heads/main/%E5%85%8B%E9%9A%86%E9%9F%B3%E8%89%B2.MP3`) 可正常访问
- 模型使用 `IndexTTS-2`，语音使用 `alloy`

## 联系方式

如有其他问题，请随时联系我们。