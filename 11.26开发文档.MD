# 11.26 开发文档：语音生成工具 v1.1 升级指南

本文档基于 `11.26需求改进.md` 编写，详细规划了从 v1.0 同步版升级到 v1.1 异步多任务版的开发步骤。

## 📅 开发阶段概览

1.  **阶段一：版本控制与环境准备** (Version Control Setup)
2.  **阶段二：API 代理升级** (Proxy Upgrade)
3.  **阶段三：数据存储层实现** (Storage Layer - IndexedDB)
4.  **阶段四：核心业务逻辑** (Core Logic - Async & Polling)
5.  **阶段五：UI 组件开发** (UI Development)
6.  **阶段六：集成与测试** (Integration & Testing)

---

## 🛠️ 详细开发步骤

### 阶段一：版本控制与环境准备 (Version Control Setup)

**目标**：实现 v1.0 和 v1.1 的代码隔离，通过 URL 参数切换。

1.  **修改 `index.html` 入口逻辑**：
    *   在 `<script>` 标签最开始添加版本检测逻辑。
    *   读取 URL 参数 `?version=`。
    *   定义全局变量 `CURRENT_VERSION` (默认为 '1.0')。

    ```javascript
    const urlParams = new URLSearchParams(window.location.search);
    const CURRENT_VERSION = urlParams.get('version') || '1.0';
    console.log(`Current Version: ${CURRENT_VERSION}`);
    ```

2.  **实现版本切换控件**：
    *   在页面右上角（Header 区域）添加一个 `<select>` 下拉菜单。
    *   选项：`v1.0 稳定版` (value="1.0"), `v1.1 开发版` (value="1.1")。
    *   **事件**：`onchange` 时修改 `window.location.search` 并刷新页面。

    ```html
    <!-- 示例 HTML -->
    <select id="version-switcher" class="absolute top-4 right-4 ...">
        <option value="1.0">v1.0 稳定版</option>
        <option value="1.1">v1.1 开发版</option>
    </select>
    ```

---

### 阶段二：API 代理升级 (Proxy Upgrade)

**目标**：更新 Cloudflare Worker 以支持异步任务接口转发。

1.  **编辑 `cf_worker.js`**：
    *   保留原有的同步接口 `/audio/speech` 转发 (用于 v1.0)。
    *   新增 `/async/audio/speech` (POST) 转发逻辑。
    *   新增 `/task/:id` (GET) 转发逻辑。
    *   **关键点**：确保 CORS 头正确返回，允许 `Authorization` 头注入。

2.  **部署 Worker**：
    *   使用 Wrangler 或 Cloudflare Dashboard 更新代码。
    *   验证：使用 Postman 或 curl 测试新接口是否通畅。

---

### 阶段三：数据存储层实现 (Storage Layer - IndexedDB)

**目标**：构建本地数据库，用于存储任务记录。

1.  **引入 `idb` 库** (可选，或使用原生 API)：
    *   为了轻量化，建议直接封装简单的原生 IndexedDB Promise 包装器，或者使用 CDN 引入 `idb-keyval` / `dexie`。考虑到项目简单，原生封装即可。

2.  **定义数据库 Schema**：
    *   DB Name: `KelongAudioDB`
    *   Store Name: `tasks`
    *   KeyPath: `id` (使用时间戳或 UUID)
    *   Index: `created_at` (用于清理过期数据)

3.  **实现 CRUD 函数**：
    *   `initDB()`: 打开数据库，升级版本时创建 Store。
    *   `saveTask(task)`: 新增或更新任务。
    *   `getTasks()`: 获取所有任务（按 `created_at` 倒序）。
    *   `deleteTask(id)`: 删除指定任务。
    *   `clearExpiredTasks()`: 遍历并删除 `Date.now() - created_at > 48h` 的记录。

---

### 阶段四：核心业务逻辑 (Core Logic - Async & Polling)

**目标**：实现“提交 -> 轮询 -> 完成”的异步流程。

1.  **重构 `generateAudio` 函数**：
    *   **v1.0 分支**：保持调用 `query()` (同步接口)。
    *   **v1.1 分支**：
        1.  调用 `submitAsyncTask(data)` (POST `/async/audio/speech`)。
        2.  获取 `task_id`。
        3.  创建初始 Task 对象 (Status: `pending`) 并存入 IndexedDB。
        4.  调用 `renderTaskList()` 更新 UI。
        5.  启动轮询 `startPolling(taskId)`。

2.  **实现 `startPolling(taskId)`**：
    *   使用 `setInterval` 或递归 `setTimeout`。
    *   每 5-10 秒请求一次 `/task/{taskId}`。
    *   **状态更新**：
        *   `success`: 更新 DB 中的状态、下载链接、Blob 数据；停止轮询；触发 UI 更新。
        *   `failed`: 更新 DB 错误信息；停止轮询；触发 UI 更新。
        *   `running/pending`: 继续轮询 (设置最大超时时间，如 10 分钟)。

---

### 阶段五：UI 组件开发 (UI Development)

**目标**：在 v1.1 模式下显示侧边栏和历史记录。

1.  **构建侧边栏容器**：
    *   在 `index.html` 中添加 `<aside>` 元素。
    *   样式：固定定位 (Fixed) 或 弹性布局 (Flex) 右侧，宽度 300px-400px。
    *   **v1.0 隐藏，v1.1 显示**。

2.  **设计任务卡片 (Task Item)**：
    *   **头部**：状态图标 (✅/❌/⏳) + 提交时间。
    *   **内容区**：
        *   文本摘要 (截取前 50 字)。
        *   **备注输入框**：`<input type="text" onblur="updateRemark(...)">`。
    *   **控制区**：
        *   **成功**：播放器 `<audio>` + 下载按钮 ⬇️。
        *   **进行中**：计时器 (动态更新 `Date.now() - created_at`)。
        *   **失败/所有**：重新生成按钮 🔄。

3.  **实现“重新生成”逻辑**：
    *   点击事件绑定 `regenerate(taskId)`。
    *   从 DB 读取该 Task 的原始参数 (`inputs`, `prompt_audio` 等)。
    *   将参数回填到左侧表单区域。
    *   (可选) 自动触发点击生成按钮。

---

### 阶段六：集成与测试 (Integration & Testing)

1.  **生命周期挂载**：
    *   页面加载 (`DOMContentLoaded`) 时：
        *   检查版本。
        *   如果是 v1.1 -> `initDB()` -> `clearExpiredTasks()` -> `getTasks()` -> `renderTaskList()`。

2.  **功能测试清单**：
    *   [ ] **版本切换**：v1.0 和 v1.1 互不影响。
    *   [ ] **异步生成**：提交任务后，侧边栏立即出现“生成中”卡片。
    *   [ ] **轮询机制**：任务完成后，卡片自动变更为“成功”并显示播放器。
    *   [ ] **数据持久化**：刷新页面，历史记录不丢失。
    *   [ ] **备注功能**：修改备注后刷新页面，备注内容保留。
    *   [ ] **过期清理**：手动修改 DB 时间戳模拟过期，验证是否自动删除。
    *   [ ] **并发测试**：连续提交 3 个任务，验证是否都能独立轮询并完成。

3.  **部署**：
    *   提交代码到 GitHub。
    *   验证 GitHub Pages 在线环境下的 Cloudflare Worker 代理连通性。

---

## 📝 附录：文件结构变更建议

```text
/ (根目录)
├── index.html          # 主入口 (包含 v1.0/v1.1 逻辑判断)
├── cf_worker.js        # 更新后的代理脚本
├── 需求文档.md          # 原始需求
├── 11.26需求改进.md     # 需求变更说明
└── 11.26开发文档.MD     # 本文档
```
