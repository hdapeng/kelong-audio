# 11.26 éœ€æ±‚æ”¹è¿›æ–‡æ¡£

## 1. æ¦‚è¿°
æœ¬æ–‡æ¡£æ—¨åœ¨è§„åˆ’è¯­éŸ³ç”Ÿæˆå·¥å…·çš„åŠŸèƒ½å‡çº§ï¼Œé‡ç‚¹åœ¨äºæ”¯æŒå¤šä»»åŠ¡å¼‚æ­¥ç”Ÿæˆã€å†å²è®°å½•ç®¡ç†ã€å¤‡æ³¨åŠŸèƒ½ä»¥åŠæ•°æ®æŒä¹…åŒ–ç­–ç•¥ã€‚ç›®æ ‡æ˜¯æå‡ç”¨æˆ·åœ¨æ‰¹é‡ç”Ÿæˆè¯­éŸ³åœºæ™¯ä¸‹çš„æ•ˆç‡å’Œä½“éªŒã€‚

## 2. æ–°å¢åŠŸèƒ½è¯¦æƒ…

### 2.1 å¤šä»»åŠ¡å¼‚æ­¥ç”Ÿæˆ (Asynchronous Generation)
*   **éœ€æ±‚æè¿°**ï¼š
    *   ä»å½“å‰çš„åŒæ­¥ç­‰å¾…æ¨¡å¼åˆ‡æ¢/æ–°å¢ä¸ºâ€œè¯­éŸ³ç”Ÿæˆå¼‚æ­¥ APIâ€ã€‚
    *   å…è®¸ç”¨æˆ·è¿ç»­æäº¤å¤šä¸ªç”Ÿæˆè¯·æ±‚ï¼Œæ— éœ€ç­‰å¾…å‰ä¸€ä¸ªå®Œæˆã€‚
*   **äº¤äº’æµç¨‹**ï¼š
    1.  ç”¨æˆ·ç‚¹å‡»â€œç”Ÿæˆâ€åï¼Œç«‹å³è¿”å›ä»»åŠ¡ IDï¼Œå‰ç«¯è¿›å…¥â€œåå°è½®è¯¢â€æˆ–â€œç­‰å¾…é€šçŸ¥â€çŠ¶æ€ã€‚
    2.  ç•Œé¢ä¸è¢«é”å®šï¼Œç”¨æˆ·å¯ç»§ç»­ä¿®æ”¹æ–‡æœ¬å¹¶æäº¤æ–°çš„ä»»åŠ¡ã€‚
    3.  ç³»ç»Ÿå†…éƒ¨ç»´æŠ¤ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œå¹¶è¡Œå¤„ç†å¤šä¸ªè¯·æ±‚ã€‚

### 2.2 ä»»åŠ¡ç®¡ç†ä¸å†å²ä¾§è¾¹æ  (Task Sidebar)
*   **éœ€æ±‚æè¿°**ï¼š
    *   åœ¨ç•Œé¢å³ä¾§ï¼ˆæˆ–å¯æŠ˜å ä¾§è¾¹æ ï¼‰æ–°å¢â€œç”Ÿæˆè®°å½•â€é¢æ¿ã€‚
    *   **æ’åºè§„åˆ™**ï¼šä¸¥æ ¼æŒ‰ç…§æäº¤æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨æœ€ä¸Šé¢ï¼‰ã€‚
*   **çŠ¶æ€æ˜¾ç¤º**ï¼š
    *   **ç”Ÿæˆä¸­ (Generating)**ï¼šæ˜¾ç¤ºåŠ¨æ€è®¡æ—¶å™¨ï¼ˆä¾‹å¦‚ï¼š`ç”Ÿæˆä¸­... 00:15`ï¼‰ï¼Œè®©ç”¨æˆ·æ„ŸçŸ¥è¿›åº¦ã€‚
    *   **å·²å®Œæˆ (Completed)**ï¼šæ˜¾ç¤ºâ€œæ’­æ”¾â€æŒ‰é’®å’Œâ€œä¸‹è½½â€æŒ‰é’®ã€‚
    *   **å¤±è´¥ (Failed)**ï¼šæ˜¾ç¤ºé”™è¯¯åŸå› åŠé‡è¯•æŒ‰é’®ã€‚
    *   **é‡æ–°ç”Ÿæˆ (Regenerate)**ï¼š
        *   åœ¨æ¯æ¡å†å²è®°å½•ï¼ˆæ— è®ºæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰ä¸­å¢åŠ â€œé‡æ–°ç”Ÿæˆâ€æŒ‰é’®ã€‚
        *   ç‚¹å‡»åï¼Œå°†è¯¥æ¡è®°å½•çš„å‚æ•°ï¼ˆInput æ–‡æœ¬ã€Prompt Audioã€Prompt Text ç­‰ï¼‰è‡ªåŠ¨å›å¡«åˆ°è¾“å…¥åŒºï¼Œæˆ–è€…ç›´æ¥å‘èµ·ä¸€ä¸ªæ–°çš„ç”Ÿæˆä»»åŠ¡ã€‚
*   **å†…å®¹å±•ç¤º**ï¼š
    *   **è‹±æ–‡ç¨¿/åŸæ–‡æ‘˜è¦**ï¼šæ˜¾ç¤ºè¯¥æ¡è¯­éŸ³å¯¹åº”çš„è¾“å…¥æ–‡æœ¬å‰ ~50 ä¸ªå­—ç¬¦ï¼Œæ–¹ä¾¿åŒºåˆ†ã€‚
    *   **éŸ³é¢‘æ§ä»¶**ï¼šå¤šæ¡å·²ç”Ÿæˆçš„è¯­éŸ³å¯ä»¥ç›´æ¥ç‚¹å‡»æ’­æ”¾ï¼Œäº’ä¸å†²çªã€‚

### 2.3 å¤‡æ³¨ç³»ç»Ÿ (Remarks)
*   **éœ€æ±‚æè¿°**ï¼š
    *   å†å²è®°å½•ä¸­çš„æ¯ä¸€æ¡é¡¹ç›®éƒ½åŒ…å«ä¸€ä¸ªå¯ç¼–è¾‘çš„â€œå¤‡æ³¨â€è¾“å…¥æ¡†ã€‚
    *   ç”¨æˆ·å¯éšæ—¶ä¿®æ”¹å¤‡æ³¨ï¼ˆä¾‹å¦‚ï¼šâ€œæµ‹è¯•ç‰ˆ1â€ï¼Œâ€œæ­£å¼ç‰ˆ-æ¿€æ˜‚â€ï¼‰ã€‚
    *   å¤‡æ³¨å†…å®¹éœ€å³æ—¶ä¿å­˜ï¼Œåˆ·æ–°é¡µé¢ä¸ä¸¢å¤±ã€‚

### 2.4 æ•°æ®å­˜å‚¨ä¸ç”Ÿå‘½å‘¨æœŸç®¡ç† (Data Persistence & Lifecycle)

#### 2.4.1 å­˜å‚¨ç­–ç•¥å†³ç­–
*   **å†³ç­–**ï¼š**æ•°æ®ç¡®å®šå­˜å‚¨åœ¨æœ¬åœ° (IndexedDB)**ã€‚
*   **ç†ç”±**ï¼šæ— éœ€æœåŠ¡å™¨æˆæœ¬ï¼Œä¿æŠ¤ç”¨æˆ·éšç§ï¼Œæ— éœ€è´¦å·ç³»ç»Ÿå³å¯åŒºåˆ†ç”¨æˆ·æ•°æ®ã€‚

#### 2.4.2 è‡ªåŠ¨è¿‡æœŸä¸æ¸…ç† (48-Hour Retention)
*   **é€»è¾‘**ï¼š
    *   æ¯æ¡è®°å½•åœ¨ç”Ÿæˆæ—¶è®°å½• `created_at` æ—¶é—´æˆ³ã€‚
    *   é¡µé¢åŠ è½½æˆ–å®šæ—¶å™¨è§¦å‘æ—¶ï¼Œæ£€æŸ¥æ‰€æœ‰è®°å½•ã€‚
    *   **è‡ªåŠ¨åˆ é™¤**ï¼šå¦‚æœ `å½“å‰æ—¶é—´ - created_at > 48å°æ—¶`ï¼Œè‡ªåŠ¨ä»æœ¬åœ°å­˜å‚¨ä¸­åˆ é™¤è¯¥æ¡è®°å½•åŠå¯¹åº”çš„éŸ³é¢‘æ•°æ®ï¼ˆé‡Šæ”¾ Blob ç©ºé—´ï¼‰ã€‚
*   **æ‰‹åŠ¨ç®¡ç†**ï¼š
    *   æä¾›â€œåˆ é™¤â€æŒ‰é’®ï¼Œå…è®¸ç”¨æˆ·æ‰‹åŠ¨ç§»é™¤ä¸éœ€è¦çš„è®°å½•ã€‚
    *   æä¾›â€œä¸€é”®æ¸…ç©ºâ€åŠŸèƒ½ã€‚

### 2.5 ç‰ˆæœ¬åˆ‡æ¢ (Version Switching)
*   **éœ€æ±‚æè¿°**ï¼š
    *   åœ¨é¡µé¢å³ä¸Šè§’å¢åŠ ä¸€ä¸ªâ€œç‰ˆæœ¬åˆ‡æ¢â€æ§ä»¶ï¼ˆå¦‚ä¸‹æ‹‰èœå•æˆ– Toggle å¼€å…³ï¼‰ã€‚
    *   **v1.0 (å½“å‰ç¨³å®šç‰ˆ)**ï¼šä¿æŒåŸæœ‰é€»è¾‘ï¼Œä½¿ç”¨åŒæ­¥ APIï¼Œå•æ¬¡ç”Ÿæˆï¼Œæ— ä¾§è¾¹æ å†å²ã€‚
    *   **v1.1 (å¼€å‘é¢„è§ˆç‰ˆ)**ï¼šå¯ç”¨å¼‚æ­¥ APIï¼Œæ”¯æŒå¤šä»»åŠ¡é˜Ÿåˆ—ï¼Œæ˜¾ç¤ºå†å²è®°å½•ä¾§è¾¹æ ã€‚
*   **ç›®çš„**ï¼š
    *   åœ¨å¼€å‘å’Œæµ‹è¯•æ–°åŠŸèƒ½ï¼ˆv1.1ï¼‰æœŸé—´ï¼Œä¿ç•™ v1.0 çš„ç¨³å®šå¯ç”¨æ€§ï¼Œé˜²æ­¢æ–°ä»£ç å¼•å…¥çš„ bug å½±å“ç°æœ‰ç”¨æˆ·ã€‚
*   **å®ç°å»ºè®®**ï¼š
    *   å¯ä»¥é€šè¿‡ URL å‚æ•°ï¼ˆå¦‚ `?version=1.1`ï¼‰æˆ–ç‹¬ç«‹å…¥å£æ–‡ä»¶ï¼ˆ`index_v1.1.html`ï¼‰æ¥åŒºåˆ†ã€‚
    *   UI ä¸Šç‚¹å‡»åˆ‡æ¢æ—¶ï¼Œè‡ªåŠ¨è·³è½¬åˆ°å¯¹åº”çš„ç‰ˆæœ¬é¡µé¢ã€‚

## 3. æŠ€æœ¯å®ç°å»ºè®® (Technical Recommendations)

### 3.1 å¼‚æ­¥ API å¯¹æ¥
**API æ–‡æ¡£åœ°å€**: `https://ai.gitee.com/hf-models/IndexTeam/IndexTTS-2/api`

**å‚è€ƒå®ç° (Node.js ç¤ºä¾‹ï¼Œéœ€é€‚é…ä¸ºå‰ç«¯ Fetch)**ï¼š
```javascript
// æ³¨æ„ï¼šå‰ç«¯å®ç°éœ€å°† fs, open ç­‰ Node æ¨¡å—æ›¿æ¢ä¸ºæµè§ˆå™¨åŸç”Ÿ API (å¦‚ fetch, Blob)
// API_URL: https://ai.gitee.com/v1/async/audio/speech
// API_TOKEN: (éœ€é€šè¿‡ Cloudflare Worker ä»£ç†æ³¨å…¥ï¼Œé¿å…å‰ç«¯æš´éœ²)

const API_URL = "https://ai.gitee.com/v1/async/audio/speech";
// const API_TOKEN = "ZZIGSINNUET0SIPCUUWGOIIZEFEDVU3QHH0V5Q1D"; // å‰ç«¯ä¸ç›´æ¥ç¡¬ç¼–ç 

async function query(data) {
    const response = await fetch(
        API_URL, // å®é™…å¼€å‘ä¸­åº”æŒ‡å‘ Cloudflare Worker ä»£ç†åœ°å€
        {
            headers: {
                "Content-Type": "application/json",
                // "Authorization": `Bearer ${API_TOKEN}` // ä»£ç†å¤„ç†é‰´æƒ
            },
            method: "POST",
            body: JSON.stringify(data)
        }
    );
    return response.json();
}

async function pollTask(taskId) {
    const statusUrl = `https://ai.gitee.com/v1/task/${taskId}`; // éœ€é€šè¿‡ä»£ç†
    const retryInterval = 10 * 1000; // 10ç§’è½®è¯¢ä¸€æ¬¡
    const maxAttempts = (30 * 60) / 10; // æœ€å¤§å°è¯•æ¬¡æ•°

    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
        console.log(`Checking task status [${attempt}]...`);
        const response = await fetch(statusUrl /* , { headers } */);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status} ${response.statusText}`);
        }
        
        const result = await response.json();
        if (result.error) {
            throw new Error(`${result.error}: ${result.message || "Unknown error"}`);
        }
        
        const status = result.status || "unknown";
        console.log("Task Status:", status);

        if (status === "success") {
            if (result.output?.file_url) {
                // è®¡ç®—è€—æ—¶
                const duration = ((result.completed_at || 0) - (result.started_at || 0)) / 1000;
                console.log(`ğŸ”— Download link: ${result.output.file_url}`);
                console.log(`â±ï¸ Task duration: ${duration.toFixed(2)}s`);
                return { ...result, duration }; // è¿”å›ç»“æœä¾›å‰ç«¯å¤„ç†
            } else {
                console.warn("âš ï¸ No output URL found");
            }
        } else if (["failed", "cancelled"].includes(status)) {
            console.error(`âŒ Task ${status}`);
            return result; // è¿”å›å¤±è´¥çŠ¶æ€
        } else {
            // ç»§ç»­ç­‰å¾…
            await new Promise((resolve) => setTimeout(resolve, retryInterval));
            continue;
        }
    }

    return { status: "timeout", message: "Maximum wait time exceeded" };
}

// è°ƒç”¨ç¤ºä¾‹
async function generate() {
    const result = await query({
        "inputs": "ç¤ºä¾‹æ–‡æœ¬...",
        "model": "IndexTTS-2",
        "prompt_audio_url": "https://...",
        "prompt_text": "æç¤ºæ–‡æœ¬...",
        "emo_text": "æƒ…æ„Ÿæ–‡æœ¬...",
        "use_emo_text": true
    });
    
    const taskId = result.task_id;
    if (taskId) {
        console.log(`Task ID: ${taskId}`);
        // å‰ç«¯éœ€å°† taskId å­˜å…¥ IndexedDB å¹¶å¼€å§‹è½®è¯¢
        pollTask(taskId);
    }
}
```

### 3.2 å‰ç«¯å­˜å‚¨ç»“æ„ (Schema)
å»ºè®®ä½¿ç”¨ IndexedDB (é€šè¿‡ `idb` åº“å°è£…) å­˜å‚¨å¦‚ä¸‹å¯¹è±¡ç»“æ„ï¼š

```json
{
  "id": "task_1716xxxxxx", // å”¯ä¸€ID
  "api_task_id": "bf85...", // Gitee API è¿”å›çš„ä»»åŠ¡ID
  "text_preview": "I know I am not fighting alone...",
  "prompt_audio": "url_or_name",
  "remark": "è‡ªå®šä¹‰å¤‡æ³¨",
  "status": "pending" | "processing" | "success" | "failed",
  "created_at": 1716777600000,
  "audio_blob": [Blob Data], // æˆåŠŸåä¸‹è½½çš„éŸ³é¢‘æ–‡ä»¶
  "audio_url": "blob:http://...", // ä¸´æ—¶æ’­æ”¾åœ°å€
  "duration": 15 // ç”Ÿæˆè€—æ—¶(ç§’)
}
```

### 3.3 ç•Œé¢å¸ƒå±€è°ƒæ•´
*   **ä¿æŒç°æœ‰æ’ç‰ˆé£æ ¼**ï¼šæ•´ä½“ UI é£æ ¼ä¸ä½œå¤§å¹…æ”¹åŠ¨ã€‚
*   **ä¾§è¾¹æ é›†æˆ**ï¼šåœ¨é¡µé¢å³ä¾§æˆ–åº•éƒ¨å¢åŠ ä»»åŠ¡åˆ—è¡¨é¢æ¿ï¼Œé€‚é…ç°æœ‰è®¾è®¡è¯­è¨€ï¼ˆTailwind CSSï¼‰ã€‚

## 4. åç»­æ­¥éª¤
1.  **API ä»£ç†é…ç½®**ï¼šæ›´æ–° Cloudflare Worker ä»¥æ”¯æŒ `/async/audio/speech` å’Œ `/task/{id}` çš„è½¬å‘ã€‚
2.  **å‰ç«¯é€»è¾‘å¼€å‘**ï¼šå¼•å…¥ IndexedDBï¼Œå®ç°ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†å™¨ã€‚
3.  **UI ç»„ä»¶å¼€å‘**ï¼šå®ç°ä¾§è¾¹æ ã€è®¡æ—¶å™¨ã€å¤‡æ³¨è¾“å…¥æ¡†ç­‰ç»„ä»¶ã€‚
